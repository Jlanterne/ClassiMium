<!DOCTYPE html>
<html lang="fr">

<head>
    <script>document.documentElement.classList.add('js-ready');</script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}Gestion de classe{% endblock %}</title>

    <!-- CSS globales -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bulles_notes.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/overrides.css', v=10) }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/anim.css', v=2) }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <!-- Librairies externes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    {% block extra_css %}{% endblock %}

    <!-- Réglages UI (depuis la DB) -->
    <script id="ui-settings" type="application/json">{{ ui | tojson }}</script>
    <script>
        (function () {
            try {
                window.UI = Object.assign(
                    { anim_mode: 'slide-down', anim_duration: 520 },
                    JSON.parse(document.getElementById('ui-settings')?.textContent || '{}') || {}
                );
            } catch {
                window.UI = { anim_mode: 'slide-down', anim_duration: 520 };
            }
            document.documentElement.dataset.animMode = window.UI.anim_mode;
            document.documentElement.dataset.animDuration = String(window.UI.anim_duration);
        })();
    </script>

    <!-- Fallback jQuery local -->
    <script>
        if (!window.jQuery) {
            var s = document.createElement('script');
            s.src = "{{ url_for('static', filename='vendor/jquery-3.7.1.min.js') }}";
            document.head.appendChild(s);
        }
    </script>

    <!-- Styles utilitaires -->
    <style>
        .panel-card {
            display: flow-root;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, .08);
            padding: 16px;
            will-change: transform, opacity, clip-path;
            contain: layout paint;
        }

        .panel-card>:first-child {
            margin-top: 0;
        }

        .panel-from-actions {
            position: relative;
            z-index: 1;
            display: flow-root;
            overflow: hidden;
            min-height: 12px;
            transform: translateZ(0);
        }

        .actions-classe {
            position: sticky;
            top: 0;
            z-index: 2000;
            transform: none !important;
            opacity: 1 !important;
            transition: none !important;
        }

        .divider {
            border: 0;
            height: 1px;
            margin: 14px 0;
            background: linear-gradient(90deg, transparent, #e5e7eb, transparent);
        }

        .content--fullwidth {
            margin-left: 0 !important;
        }

        @media (prefers-reduced-motion:reduce) {
            .panel-from-actions {
                transition: none !important;
                animation: none !important;
            }
        }

        /* ===== Bloc user ===== */
        .auth-panel {
            padding: 0;
            margin: 0 0 20px;
        }

        .user-block {
            background: #EDF3FA;
            border: 1px solid #dbe7ff;
            border-radius: 12px;
            padding: 10px;
            margin: 0 0 10px 0;
            width: 100%;
            box-sizing: border-box;
        }

        .user-card-wrap {
            display: block;
        }

        .user-block-link {
            display: block;
            padding: 0;
            border-radius: 10px;
            transition: background-color .15s ease;
        }

        .user-block-link:hover {
            background: #f3f4f6;
        }

        .user-card {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #374151;
        }

        .user-meta {
            min-width: 0;
        }

        .user-name {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        .user-sub {
            color: #6b7280;
            font-size: .92em;
            display: flex;
            gap: 6px;
            align-items: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .badge-role {
            background: #eef2ff;
            color: #4338ca;
            padding: 1px 6px;
            border-radius: 6px;
            font-size: .75em;
        }

        /* Avatar carré agrandi */
        .user-avatar {
            width: 88px;
            height: 88px;
            border-radius: 8px;
            overflow: hidden;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            border-radius: 0;
        }

        /* Actions SOUS le login (pas sous la photo) */
        .user-quick {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            flex-wrap: wrap;
            /* Indentation = largeur avatar (88) + gap (10) → visuel sous le login */
            margin-left: 98px;
        }

        .icon-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            justify-content: center;
            height: 28px;
            padding: 0 10px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            background: #fff;
            cursor: pointer;
            font-size: .9rem;
            text-decoration: none;
            color: inherit;
        }

        .icon-btn:hover {
            background: #f9fafb;
        }

        .icon-btn i {
            font-size: .95em;
        }

        .icon-btn.ok {
            border-color: #22c55e;
            box-shadow: 0 0 0 2px rgba(34, 197, 94, .15) inset;
        }

        /* ===== Sidebar ===== */
        .sidebar {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 0 16px;
        }

        .sidebar-inner {
            width: 260px;
            margin: 0 auto;
            padding: 0;
        }

        .sb-item {
            margin: 0 0 16px 0;
        }

        .sb-item:last-child {
            margin-bottom: 0;
        }

        .sidebar .sb-btn,
        .sidebar button.sb-btn,
        .sidebar .btn-nouvelle-classe.sb-btn,
        .sidebar .btn-classe.sb-btn,
        .sidebar .btn-parametres.sb-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            box-sizing: border-box;
            margin: 0 !important;
            text-align: center;
        }

        .sidebar form.sb-item {
            margin: 0 0 16px 0;
            padding: 0;
        }

        .sb-hr {
            width: 100%;
            margin: 16px 0;
            border: 0;
            height: 1px;
            background: #e5e7eb;
        }

        /* ===== Affichage niveaux / année ===== */
        .niv {
            color: #ffffff;
            font-weight: 600;
        }

        .sep {
            color: #ffffff;
        }

        .annee {
            color: #a6b8ce;
            font-weight: 600;
        }
    </style>
</head>

<body class="anim-{{ ui.anim_mode|default('slide') }}" data-anim-mode="{{ ui.anim_mode|default('slide') }}"
    data-anim-duration="{{ ui.anim_duration|default(520) }}">
    {% set is_auth = session.get('auth') %}

    <div class="main-container">
        <!-- ===== Sidebar ===== -->
        <aside class="sidebar">
            <div class="sidebar-inner">
                <table style="border-collapse:separate;border-spacing:0;border:none;outline:none;">
                    <tr>
                        <td style="padding:10px;vertical-align:top;position:relative;height:120px;line-height:0;">
                            <img src="{{ url_for('static', filename='photos/logo_CLassiMium.svg') }}" alt="Logo"
                                style="display:block;position:absolute;top:14px;left:0;height:80%;z-index:9999;">
                        </td>
                    </tr>
                </table>

                <br>

                <!-- ===== Auth panel ===== -->
                <div class="auth-panel">
                    {% if is_auth %}
                    <div class="user-block sb-item">
                        <div class="user-card-wrap">
                            <a href="{{ url_for('users.profile') }}" class="user-block-link"
                                aria-label="Ouvrir mon profil">
                                <div class="user-card">
                                    <div class="user-avatar">
                                        {% if session.get('user_photo_url') %}
                                        <img src="{{ session.get('user_photo_url') }}" alt="Photo utilisateur">
                                        {% else %}
                                        <img src="{{ url_for('static', filename='photos/users/default_user.png') }}"
                                            alt="Photo utilisateur">
                                        {% endif %}
                                    </div>
                                    <div class="user-meta">
                                        <div class="user-name">{{ session.get('display_name') or session.get('username')
                                            or 'Connecté' }}</div>
                                        <div class="user-sub">
                                            {% if session.get('role') %}<span class="badge-role">{{ session.get('role')
                                                }}</span>{% endif %}
                                            {% if session.get('email') %}<span class="user-email">{{
                                                session.get('email') }}</span>{% endif %}
                                        </div>
                                    </div>
                                </div>
                            </a>

                            <!-- Boutons SOUS le login (alignés à droite) -->
                            <div class="user-quick">
                                <!-- 1 bouton : ouvre l’Explorateur via protocole classimium-en:// + callback -->
                                <button type="button" class="icon-btn js-open-en"
                                    title="Ouvrir le dossier Éducation Nationale">
                                    <i class="fa-regular fa-folder-open"></i> EN
                                </button>

                                <!-- Logout -->
                                <form action="{{ url_for('auth.logout') }}" method="get" style="margin:0;">
                                    <button type="submit" class="icon-btn" title="Se déconnecter"
                                        aria-label="Se déconnecter">
                                        <i class="fa-solid fa-right-from-bracket"></i>
                                    </button>
                                </form>
                            </div>

                            <!-- Aide statique (masquée automatiquement après succès) -->
                            <div id="en-hint-static" style="margin-top:6px;color:#6b7280;font-size:.85em;">
                                Première utilisation : si rien ne s’ouvre, installe le bouton EN (une seule fois).
                                <a href="{{ url_for('main.download_en_reg') }}">Télécharger l’installeur</a>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="user-block sb-item">
                        <div class="user-card">
                            <div class="user-avatar">
                                <img src="{{ url_for('static', filename='photos/users/default_user.png') }}"
                                    alt="Photo utilisateur">
                            </div>
                            <div class="user-name">Non connecté</div>
                        </div>
                    </div>
                    <form action="{{ url_for('auth.login') }}" method="get" class="sb-item">
                        <button type="submit" class="btn-nouvelle-classe sb-btn btn-auth">
                            <i class="fa-solid fa-right-to-bracket"></i> Se connecter
                        </button>
                    </form>
                    {% endif %}
                </div>

                {% if is_auth %}
                <form method="get" action="{{ url_for('main.index') }}" class="sb-item">
                    <button type="submit" class="btn-nouvelle-classe sb-btn">➕ Créer une nouvelle classe</button>
                </form>

                <hr class="sb-hr">

                {% for cl in toutes_les_classes %}
                <form action="{{ url_for('main.page_classe', classe_id=cl.id) }}" method="get" class="sb-item">
                    <button type="submit" class="btn-classe sb-btn">
                        <span class="niv">{{ cl.niveaux | format_niveaux }}</span>
                        <span class="sep"> - </span>
                        <span class="annee">{{ cl.annee | format_annee }}</span>
                    </button>
                </form>
                {% endfor %}

                <hr class="sb-hr">
                <form action="{{ url_for('main.config_export') }}" method="get" class="sb-item">
                    <button type="submit" class="btn-nouvelle-classe sb-btn">
                        <i class="fa-solid fa-gear" style="margin-right:6px;"></i> Paramètres
                    </button>
                </form>
                {% endif %}
            </div>
        </aside>

        <!-- ===== Contenu ===== -->
        <main class="content{% if not is_auth %} content--fullwidth{% endif %}">
            <div class="bandeau-titre">
                {% block header_title %}
                {% if classe %}
                <span class="niv">{{ classe.niveaux | format_niveaux }}</span>
                <span class="sep"> - </span>
                <span class="annee">{{ classe.annee | format_annee }}</span>
                {% elif evaluation %}
                Classe {{ evaluation.classe_id }}
                {% else %}
                Gestion de classe
                {% endif %}
                {% endblock %}
            </div>

            <div id="page">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    <!-- DataTables : init simple -->
    <script>
        (function initDataTables() {
            if (!window.jQuery) { console.warn('jQuery absent → skip DataTables'); return; }
            jQuery(function ($) {
                const $tbl = $('#eleves-table');
                if (!$tbl.length || !$.fn || !$.fn.DataTable) return;
                if ($.fn.DataTable.isDataTable($tbl)) {
                    $tbl.DataTable().columns.adjust().draw(false);
                    return;
                }
                $tbl.DataTable({
                    paging: false, info: false, searching: false, order: [],
                    columnDefs: [{ targets: 3, orderData: [3, 0] }]
                });
                const table = $tbl.DataTable();
                const $th3 = $tbl.find('thead th').eq(3);
                if ($th3.length) {
                    $th3.off('click.dt-niveau').on('click.dt-niveau', function () {
                        const cur = table.order(); let dir = 'asc';
                        if (cur.length && cur[0][0] === 3) dir = (cur[0][1] === 'asc') ? 'desc' : 'asc';
                        table.order([[3, dir], [0, 'asc']]).draw();
                    });
                }
            });
        })();
    </script>

    {% block extra_js %}
    <script src="{{ url_for('static', filename='js/modes.js') }}"></script>
    {% endblock %}

    <!-- Bouton EN — Protocole + ping + aide une seule fois -->
    <script>
        (function () {
            const HAS_KEY = "enProtoInstalled";
            const CHECK_URL = "{{ url_for('main.protocol_check') }}";
            // IMPORTANT: garde le même host:port que la page courante
            const CB_BASE = location.origin + "{{ url_for('main.protocol_callback') }}";

            function showHelpOnce() {
                if (localStorage.getItem(HAS_KEY) === "1") return;
                if (document.getElementById("en-help")) return;
                const wrap = document.createElement("div");
                wrap.id = "en-help";
                wrap.style.cssText = "margin-top:8px;font-size:.9rem;color:#6b7280;";
                wrap.innerHTML = `Si rien ne s'est ouvert, <a href="{{ url_for('main.download_en_reg') }}">installe le connecteur (.reg)</a>, puis réessaie.`;
                document.querySelector(".user-quick")?.appendChild(wrap);
            }
            function hideHelp() { document.getElementById("en-help")?.remove(); }

            async function openEN() {
                const nonce = (Date.now().toString(36) + Math.random().toString(36).slice(2));
                const cb = encodeURIComponent(CB_BASE + "?nonce=" + nonce);
                const href = "classimium-en://" + cb;

                let lostFocus = false;
                const onBlur = () => { lostFocus = true; };
                const onVis = () => { if (document.visibilityState === "hidden") lostFocus = true; };

                window.addEventListener("blur", onBlur, { once: true, capture: true });
                document.addEventListener("visibilitychange", onVis, { once: true });
                window.addEventListener("pagehide", onBlur, { once: true });

                // Lancement via gesture utilisateur
                window.location.href = href;

                // Attente: soit le handler ping, soit la fenêtre perd le focus (Explorer a pris le focus)
                const deadline = Date.now() + 4500;
                while (Date.now() < deadline) {
                    try {
                        const r = await fetch(CHECK_URL + "?nonce=" + encodeURIComponent(nonce), { cache: "no-store" });
                        if (r.ok) {
                            const j = await r.json();
                            if (j.status === "ok") {
                                window.removeEventListener("blur", onBlur, { capture: true });
                                document.removeEventListener("visibilitychange", onVis);
                                window.removeEventListener("pagehide", onBlur);
                                return true;
                            }
                        }
                    } catch { }
                    if (lostFocus) {
                        window.removeEventListener("blur", onBlur, { capture: true });
                        document.removeEventListener("visibilitychange", onVis);
                        window.removeEventListener("pagehide", onBlur);
                        return true;
                    }
                    await new Promise(r => setTimeout(r, 250));
                }
                window.removeEventListener("blur", onBlur, { capture: true });
                document.removeEventListener("visibilitychange", onVis);
                window.removeEventListener("pagehide", onBlur);
                return false;
            }

            document.addEventListener("click", async (e) => {
                const btn = e.target.closest(".js-open-en");
                if (!btn) return;
                e.preventDefault();

                hideHelp();
                btn.disabled = true;
                const ok = await openEN();
                btn.disabled = false;

                if (ok) {
                    localStorage.setItem(HAS_KEY, "1");  // ne repropose plus l’installation
                    hideHelp();
                } else {
                    showHelpOnce();
                }
            });

            // si déjà validé auparavant, ne jamais afficher l’aide
            if (localStorage.getItem(HAS_KEY) === "1") hideHelp();
        })();
    </script>

</body>

</html>