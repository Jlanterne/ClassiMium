{% block content %}
<link rel="stylesheet" href="{{ url_for('seating.static', filename='plan_classe.css') }}">

<noscript>
  <div class="pc_alert">Active JavaScript pour utiliser le plan de classe.</div>
</noscript>

<!-- ===== Toolbar ===== -->
<div class="pc_toolbar" role="toolbar" aria-label="Actions du plan de classe">
  <div class="pc_left">
    <select id="pc_plan_select" aria-label="Sélection du plan"></select>
    <button id="pc_new_plan" type="button">Nouveau plan</button>
    <button id="pc_duplicate" type="button">Dupliquer</button>
    <button id="pc_delete_plan" type="button" class="danger">Supprimer</button>

    <button id="pc_activate" type="button">Activer</button>
    <button id="pc_export_pdf" type="button">Exporter PDF</button>
    <button id="pc_reset_plan" type="button" title="Shift+clic = reset complet">Réinitialiser</button>
    <button id="pc_edit_mode" class="pc_btn" type="button">Édition meubles : OFF</button>
    <!-- À coller juste après le bouton #pc_edit_mode -->
    <div id="pc_align_bar" class="pc-align-bar" hidden>
      <button id="btn_align_left" type="button" title="Aligner à gauche">⟸</button>
      <button id="btn_align_right" type="button" title="Aligner à droite">⟹</button>
      <button id="btn_align_top" type="button" title="Aligner en haut">⟰</button>
      <button id="btn_align_bottom" type="button" title="Aligner en bas">⟱</button>
      <span class="sep"></span>
      <button id="btn_dist_h" type="button" title="Répartir horizontalement">⇔</button>
      <button id="btn_dist_v" type="button" title="Répartir verticalement">⇕</button>
    </div>

  </div>

  <button id="pc_fullscreen" type="button">Plein écran</button>
</div>

<!-- ===== Layout à 3 colonnes : Élèves | Plan | Meubles ===== -->
<div class="pc_layout">
  <!-- Colonne gauche : Élèves non placés -->
  <aside class="pc_side" aria-label="Élèves non placés">
    <h4 class="pc_head">Élèves (non placés)</h4>
    <div id="pc_eleve_list" class="pc_eleve_list" role="list"></div>
  </aside>

  <!-- Colonne centrale : la scène (plan) -->
  <main class="pc_stage_wrap" aria-label="Surface du plan">
    <div id="pc_stage" class="pc_stage" data-classe-id="{{ classe_id }}" data-grid="32" aria-label="Surface du plan">
      <!-- Calque SVG (murs, cotes, etc.) -->
      <svg id="pc_svg" class="pc_svg" aria-hidden="true"></svg>
      <!-- Calque HTML des objets (meubles, portes, fenêtres, cartes élèves) -->
      <div id="pc_scene"></div>
    </div>
  </main>

  <!-- Colonne droite : Palette de meubles + AutoWalls -->
  <aside class="pc_side" aria-label="Meubles disponibles">
    <h4 class="pc_head">Meubles</h4>
    <div id="pc_furn_palette" class="pc_furn_palette" role="list"></div>
    <button id="pc_add_furniture" class="pc_btn_add" type="button">+ Meuble / Bureau</button>

    <!-- ===== Traçage automatique des murs ===== -->
    <section id="pc_auto_walls" class="pc-section">
      <h3 class="pc-section-title">Traçage automatique des murs</h3>

      <div class="pc-auto-walls-actions">
        <div id="aw_handle_token" class="aw-token" draggable="true" title="Glisser sur le plan">
          ● Point de départ
        </div>
      </div>

      <p class="pc-help">Clique sur le plan pour choisir le <strong>point de départ</strong>.</p>
      <div id="aw_start_display" class="pc-start-display">Aucun point choisi</div>

      <div class="pc-aw-field" style="margin:6px 0">
        <label for="aw_angle_mode">Type d’angle</label>
        <select id="aw_angle_mode">
          <option value="interior" selected>Angle intérieur</option>
          <option value="turn">Tournant (rotation)</option>
          <option value="absolute">Azimut absolu</option>
        </select>
      </div>

      <div class="pc-auto-walls-rows" id="aw_rows">
        <!-- Les lignes (mur/angle) s’ajoutent automatiquement ici -->
      </div>

      <div class="pc-auto-walls-actions">
        <button type="button" id="aw_add_row">+ Ajouter un segment</button>
        <label class="pc-inline">
          <input type="checkbox" id="aw_close" checked>
          Fermer le polygone
        </label>
      </div>

      <div class="pc-auto-walls-actions">
        <button type="button" id="aw_validate" class="primary">Valider → Créer les murs</button>
        <button type="button" id="aw_clear">Réinitialiser</button>
      </div>
    </section>
  </aside>
</div>

<!-- ===== Bootstrapping JS (URLs & config) ===== -->
<script>
  // ID de classe (JSON-safe)
  var CLASS_ID = JSON.parse('{{ classe_id | tojson | safe }}');

  // On part d'une URL réelle pour dériver la racine API
  // ex: /seating/api/plans/0  -> racine: /seating
  var _plans0 = "{{ url_for('seating.api_get_plans', classe_id=0) }}";
  var API_BASE_ROOT = _plans0.replace(/\/api\/plans\/0$/, "");

  // Si ton backend n'accepte QUE /api/plans/<id>/delete, mets ceci à true :
  var USE_DELETE_SUFFIX = false;

  // URL potentielle de type ".../delete" si tu as une route dédiée
  var _deleteWithSuffix = "{{ url_for('seating.api_delete_plan', plan_id=0) }}"; // ex: /seating/api/plans/0/delete

  function deletePlanUrl(id) {
    if (USE_DELETE_SUFFIX) {
      return _deleteWithSuffix.replace(/0$/, String(id));
    }
    // Par défaut, on privilégie l'endpoint REST standard
    return API_BASE_ROOT + "/api/plans/" + id;
  }

  window.SEATING_URLS = {
    getPlans: _plans0.replace(/0$/, String(CLASS_ID)),
    createPlan: API_BASE_ROOT + "/api/plans",
    activate: (id) => API_BASE_ROOT + "/api/plans/" + id + "/activate",
    duplicate: (id) => API_BASE_ROOT + "/api/plans/" + id + "/duplicate",
    upsertPositions: (id) => API_BASE_ROOT + "/api/plans/" + id + "/positions",
    upsertFurniture: (id) => API_BASE_ROOT + "/api/plans/" + id + "/furniture",
    exportPdf: (id) => API_BASE_ROOT + "/api/plans/" + id + "/export/pdf",
    deletePlan: (id) => deletePlanUrl(id) // <— utilisé par plan_classe.js
  };

  window.SEATING_CONF = {
    classeId: CLASS_ID,
    apiBase: API_BASE_ROOT,
    grid: 32,
    // Garde bien le slash final
    photosBase: "{{ url_for('static', filename='photos/') }}"
  };
</script>

<!-- Petit log de vérif côté client (facultatif) -->
<script>
  console.log("[pc] stage present:", !!document.getElementById('pc_stage'));
  fetch(window.SEATING_CONF.apiBase + "/api/plans/" + window.SEATING_CONF.classeId, { credentials: "same-origin" })
    .then(r => (console.log("[pc] GET", r.status, r.url), r.json()))
    .then(j => console.log("[pc] payload keys:", Object.keys(j || {})))
    .catch(e => console.error("[pc] fetch error:", e));
</script>

<!-- Ton script principal -->
<script src="{{ url_for('seating.static', filename='plan_classe.js') }}" defer></script>
{% endblock %}