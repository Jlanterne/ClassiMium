<!DOCTYPE html>
<html lang="fr">

<head>
    <!-- Pose js-ready AVANT les CSS pour éviter les “sauts” -->
    <script>document.documentElement.classList.add('js-ready');</script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>{% block title %}Gestion de classe{% endblock %}</title>

    <!-- CSS globales -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bulles_notes.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/overrides.css', v=10) }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/anim.css', v=2) }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <!-- Librairies externes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <!-- CSS additionnel (pages enfants) -->
    {% block extra_css %}{% endblock %}

    <!-- Réglages UI injectés par le serveur -->
    <script id="ui-settings" type="application/json">
    {{ ui | tojson }}
  </script>
    <script>
        (function () {
            try {
                window.UI = Object.assign(
                    { anim_mode: 'slide', anim_duration: 520 },
                    JSON.parse(document.getElementById('ui-settings')?.textContent || '{}')
                );
            } catch {
                window.UI = { anim_mode: 'slide', anim_duration: 520 };
            }
            document.documentElement.dataset.animMode = window.UI.anim_mode;
            document.documentElement.dataset.animDuration = String(window.UI.anim_duration);
        })();
    </script>

    <!-- Fallback jQuery local si le CDN tombe -->
    <script>
        if (!window.jQuery) {
            var s = document.createElement('script');
            s.src = "{{ url_for('static', filename='vendor/jquery-3.7.1.min.js') }}";
            document.head.appendChild(s);
        }
    </script>

    <!-- Styles utilitaires (pouvant aller plus tard dans overrides.css) -->
    <style>
        .panel-card {
            display: flow-root;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, .08);
            padding: 16px;
            will-change: transform, opacity, clip-path;
            contain: layout paint;
        }

        .panel-card> :first-child {
            margin-top: 0;
        }

        .panel-from-actions {
            position: relative;
            z-index: 1;
            /* sous la barre d’actions */
            display: flow-root;
            overflow: hidden;
            /* requis pour wipe/clip */
            min-height: 12px;
            /* anti micro-jumps */
            transform: translateZ(0);
            /* lissage GPU */
        }

        .actions-classe {
            position: sticky;
            top: 0;
            z-index: 2000;
            transform: none !important;
            opacity: 1 !important;
            transition: none !important;
        }

        .divider {
            border: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, #e5e7eb, transparent);
            margin: 14px 0;
        }

        @media (prefers-reduced-motion: reduce) {
            .panel-from-actions {
                transition: none !important;
                animation: none !important;
            }
        }
    </style>
</head>

<body class="anim-{{ ui.anim_mode|default('slide') }}" data-anim-mode="{{ ui.anim_mode|default('slide') }}"
    data-anim-duration="{{ ui.anim_duration|default(520) }}">

    <div class="main-container">
        <!-- ===== Sidebar ===== -->
        <aside class="sidebar">
            <table style="
    border-collapse:separate;
    border-spacing:8px;
    border:none;
    outline:none;
">
                <tr style="border:none;outline:none;">
                    <td style="
            padding:10px;
            vertical-align:top;
            overflow:visible;      /* permet le débordement */
            position:relative;
            height:120px;          /* hauteur fixe */
            line-height:0;         /* supprime l'espace fantôme */
            border:none;
            outline:none;
            background:none;
        ">
                        <img src="{{ url_for('static', filename='photos/logo_CLassiMium.svg') }}" alt="Logo" style="
                display:block;
                position:absolute;
                top:-30px;          /* remonte l'image */
                left:-12px;         /* décale à gauche */
                height:100%;
                z-index:9999;
                border:none;
                outline:none;
                background:none;
            ">
                    </td>
                </tr>
            </table>

            <br>

            {% if classe %}
            <form method="get" action="{{ url_for('main.page_classe', classe_id=classe.id) }}">
                <input type="hidden" name="mode" value="creation_classe">
                <button type="submit" class="btn-nouvelle-classe">➕ Créer une nouvelle classe</button>
            </form>
            {% endif %}

            <hr style="margin:20px 0">

            {% for cl in toutes_les_classes %}
            <form action="{{ url_for('main.page_classe', classe_id=cl.id) }}" method="get">
                <button type="submit" class="btn-classe">{{ cl.niveaux | join(' / ') }} {{ cl.annee }}</button>
            </form>
            {% endfor %}

            <hr style="margin:20px 0">

            <form action="{{ url_for('main.config_export') }}" method="get">
                <button type="submit" class="btn-classe btn-parametres">
                    <i class="fa-solid fa-gear" style="margin-right:6px;"></i> Paramètres
                </button>
            </form>
        </aside>

        <!-- ===== Contenu ===== -->
        <main class="content">
            <div class="bandeau-titre">
                {% block header_title %}
                {% if classe %}
                Classe {{ classe.niveaux | join(' / ') }} {{ classe.annee }}
                {% elif evaluation %}
                Classe {{ evaluation.classe_id }}
                {% else %}
                Gestion de classe
                {% endif %}
                {% endblock %}
            </div>

            {# Messages flash (désactivés par défaut)
            {% with messages = get_flashed_messages() %}
            {% if messages %}
            <ul class="flashes">
                {% for message in messages %}
                <li>{{ message }}</li>
                {% endfor %}
            </ul>
            {% endif %}
            {% endwith %}
            #}

            <div id="page">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    <!-- DataTables : init simple et sûre -->
    <script>
        (function initDataTables() {
            if (!window.jQuery) { console.warn('jQuery absent → skip DataTables'); return; }
            jQuery(function ($) {
                const $tbl = $('#eleves-table');
                if (!$tbl.length || !$.fn || !$.fn.DataTable) return;
                if ($.fn.DataTable.isDataTable($tbl)) {
                    $tbl.DataTable().columns.adjust().draw(false);
                    return;
                }
                $tbl.DataTable({
                    paging: false, info: false, searching: false, order: [],
                    columnDefs: [{ targets: 3, orderData: [3, 0] }]
                });
                const table = $tbl.DataTable();
                const $th3 = $tbl.find('thead th').eq(3);
                if ($th3.length) {
                    $th3.off('click.dt-niveau').on('click.dt-niveau', function () {
                        const cur = table.order();
                        let dir = 'asc';
                        if (cur.length && cur[0][0] === 3) dir = (cur[0][1] === 'asc') ? 'desc' : 'asc';
                        table.order([[3, dir], [0, 'asc']]).draw();
                    });
                }
            });
        })();
    </script>

    <!-- JS additionnel (pages enfants) : on y charge le SEUL moteur d’anim -->
    {% block extra_js %}
    <script src="{{ url_for('static', filename='js/modes.js') }}"></script>
    {% endblock %}


</body>

</html>