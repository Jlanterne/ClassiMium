<div class="container-global-bulles">
    {% set matieres = [
    {'nom': 'Français', 'couleur': '#87cefa', 'moyenne': 17.2, 'niveau': 'A', 'sous_matieres': [
    {'nom': 'Orthographe', 'niveau': 'NA', 'note_finale': 18, 'niveau_final': 'A', 'objectifs': [
    {'texte': 'Accorder les adjectifs', 'niveau': 'A'},
    {'texte': 'Orthographier les mots fréquents', 'niveau': 'PA'}
    ]},
    {'nom': 'Vocabulaire', 'niveau': 'PA-', 'note_finale': 14, 'niveau_final': 'D', 'objectifs': [
    {'texte': 'Comprendre le sens d’un mot selon le contexte', 'niveau': 'PA'},
    {'texte': 'Utiliser des synonymes', 'niveau': 'A'}
    ]},
    {'nom': 'Grammaire', 'niveau': 'PA', 'note_finale': 13, 'niveau_final': 'PA+', 'objectifs': [
    {'texte': 'Identifier les groupes dans une phrase', 'niveau': 'PA'},
    {'texte': 'Utiliser les pronoms personnels', 'niveau': 'PA'}
    ]},
    {'nom': 'Conjugaison', 'niveau': 'PA+', 'note_finale': 12, 'niveau_final': 'PA', 'objectifs': [
    {'texte': 'Conjuguer au présent', 'niveau': 'PA'},
    {'texte': 'Conjuguer à l’imparfait', 'niveau': 'PA'}
    ]},
    {'nom': 'Dictée', 'niveau': 'A-', 'note_finale': 19, 'niveau_final': 'A+', 'objectifs': [
    {'texte': 'Accorder le sujet et le verbe', 'niveau': 'A'},
    {'texte': 'Orthographe des mots invariables', 'niveau': 'A'}
    ]},
    {'nom': 'Lecture', 'niveau': 'A', 'note_finale': 17, 'niveau_final': 'A', 'objectifs': [
    {'texte': 'Lire avec fluidité', 'niveau': 'A'},
    {'texte': 'Comprendre un texte narratif', 'niveau': 'PA'}
    ]},
    {'nom': 'Écriture', 'niveau': 'A+', 'note_finale': 15, 'niveau_final': 'A-', 'objectifs': [
    {'texte': 'Rédiger un paragraphe cohérent', 'niveau': 'PA'},
    {'texte': 'Utiliser le lexique approprié', 'niveau': 'A'}
    ]},
    {'nom': 'Expression orale', 'niveau': 'D', 'note_finale': 20, 'niveau_final': 'D', 'objectifs': [
    {'texte': 'Parler clairement devant les autres', 'niveau': 'A'},
    {'texte': 'Répondre à une question posée', 'niveau': 'A'}
    ]},
    {'nom': 'Poésie', 'niveau': 'A', 'note_finale': 16, 'niveau_final': 'A', 'objectifs': [
    {'texte': 'Mémoriser un texte court', 'niveau': 'PA'},
    {'texte': 'Réciter avec intonation', 'niveau': 'A'}
    ]}
    ]},

    {'nom': 'Mathématiques', 'couleur': '#f4a460', 'moyenne': 13.8, 'niveau': 'PA+', 'sous_matieres': [
    {'nom': 'Numération', 'niveau': 'PA', 'note_finale': 13, 'niveau_final': 'PA', 'objectifs': [
    {'texte': 'Lire des nombres jusqu’à 10 000', 'niveau': 'PA'},
    {'texte': 'Comparer des nombres', 'niveau': 'A'}
    ]},
    {'nom': 'Calcul', 'niveau': 'PA+', 'note_finale': 15, 'niveau_final': 'PA+', 'objectifs': [
    {'texte': 'Poser une addition', 'niveau': 'A'},
    {'texte': 'Soustraire des nombres entiers', 'niveau': 'PA'}
    ]},
    {'nom': 'Calcul mental', 'niveau': 'A-', 'note_finale': 16, 'niveau_final': 'A-', 'objectifs': [
    {'texte': 'Utiliser les doubles', 'niveau': 'PA'},
    {'texte': 'Multiplier de tête', 'niveau': 'A'}
    ]},
    {'nom': 'Géométrie', 'niveau': 'PA-', 'note_finale': 11, 'niveau_final': 'PA-', 'objectifs': [
    {'texte': 'Reconnaître des figures', 'niveau': 'PA'},
    {'texte': 'Tracer un carré', 'niveau': 'PA'}
    ]},
    {'nom': 'Mesures', 'niveau': 'PA', 'note_finale': 14, 'niveau_final': 'PA', 'objectifs': [
    {'texte': 'Lire l’heure', 'niveau': 'PA'},
    {'texte': 'Mesurer une longueur', 'niveau': 'A'}
    ]}
    ]},

    {'nom': 'QLM', 'couleur': '#98fb98', 'moyenne': 14.2, 'niveau': 'PA+', 'sous_matieres': [
    {'nom': 'Le temps', 'niveau': 'PA', 'note_finale': 13, 'niveau_final': 'PA+', 'objectifs': [
    {'texte': 'Lire un calendrier', 'niveau': 'PA'},
    {'texte': 'Placer un événement dans une frise', 'niveau': 'A'}
    ]},
    {'nom': 'L’espace', 'niveau': 'PA-', 'note_finale': 12, 'niveau_final': 'PA', 'objectifs': [
    {'texte': 'Lire une carte', 'niveau': 'PA'},
    {'texte': 'Se repérer dans un plan', 'niveau': 'PA'}
    ]},
    {'nom': 'Le vivant', 'niveau': 'A-', 'note_finale': 16, 'niveau_final': 'A-', 'objectifs': [
    {'texte': 'Identifier les besoins d’un être vivant', 'niveau': 'A'},
    {'texte': 'Connaître le cycle de vie', 'niveau': 'PA'}
    ]},
    {'nom': 'La matière', 'niveau': 'PA', 'note_finale': 13, 'niveau_final': 'PA', 'objectifs': [
    {'texte': 'Connaître les états de la matière', 'niveau': 'PA'},
    {'texte': 'Classer des objets selon leurs propriétés', 'niveau': 'A'}
    ]}
    ]},

    {'nom': 'Anglais', 'couleur': '#ff4500', 'moyenne': 17.0, 'niveau': 'A', 'sous_matieres': [
    {'nom': 'Anglais', 'niveau': 'A', 'note_finale': 17, 'niveau_final': 'A', 'objectifs': [
    {'texte': 'Se présenter', 'niveau': 'A'},
    {'texte': 'Comprendre une consigne simple', 'niveau': 'A'}
    ]}
    ]},

    {'nom': 'EPS', 'couleur': '#ffff00', 'moyenne': 15.0, 'niveau': 'A-', 'sous_matieres': [
    {'nom': 'EPS', 'niveau': 'A-', 'note_finale': 15, 'niveau_final': 'A-', 'objectifs': [
    {'texte': 'Courir longtemps', 'niveau': 'PA'},
    {'texte': 'Coopérer en jeu collectif', 'niveau': 'A'}
    ]}
    ]},

    {'nom': 'EMC', 'couleur': '#a9a9a9', 'moyenne': 16.5, 'niveau': 'A', 'sous_matieres': [
    {'nom': 'EMC', 'niveau': 'A', 'note_finale': 16, 'niveau_final': 'A', 'objectifs': [
    {'texte': 'Respecter les règles', 'niveau': 'A'},
    {'texte': 'Comprendre la notion de droit', 'niveau': 'PA'}
    ]}
    ]},

    {'nom': 'Arts plastiques', 'couleur': '#a0522d', 'moyenne': 14.5, 'niveau': 'PA+', 'sous_matieres': [
    {'nom': 'Arts plastiques', 'niveau': 'PA+', 'note_finale': 14.5, 'niveau_final': 'PA+', 'objectifs': [
    {'texte': 'Créer une œuvre en volume', 'niveau': 'PA'},
    {'texte': 'Utiliser différentes techniques', 'niveau': 'A'}
    ]}
    ]},

    {'nom': 'Musique', 'couleur': '#7b68ee', 'moyenne': 15.8, 'niveau': 'A-', 'sous_matieres': [
    {'nom': 'Musique', 'niveau': 'A-', 'note_finale': 15.8, 'niveau_final': 'A-', 'objectifs': [
    {'texte': 'Reproduire un rythme', 'niveau': 'A'},
    {'texte': 'Chanter en groupe', 'niveau': 'PA'}
    ]}
    ]},

    {'nom': 'Autres', 'couleur': '#607D8B', 'moyenne': 16.0, 'niveau': 'A', 'sous_matieres': [
    {'nom': 'Autres', 'niveau': 'A', 'note_finale': 16, 'niveau_final': 'A', 'objectifs': [
    {'texte': 'Participer à un projet', 'niveau': 'A'},
    {'texte': 'Être autonome', 'niveau': 'PA'}
    ]}
    ]}
    ] %}

    <div class="matiere-container">
        {% for matiere in matieres %}
        <div class="bloc-matiere" style="--matiere-color: {{ matiere.couleur }};">
            <div class="titre-matiere" onclick="toggleMatiere(this)">
                {{ matiere.nom }}
                <span class="moyenne-droite">
                    <span class="note-sur-20">{{ matiere.moyenne }} / 20</span>
                    <span class="pastille-niveau {{ matiere.niveau }}">{{ matiere.niveau }}</span>
                </span>
            </div>

            <div class="moyenne-repliee">
                <span class="pastille-niveau {{ matiere.niveau }}">{{ matiere.niveau }}</span>
            </div>

            <div class="contenu-matiere">
                <div class="liste-sous-matieres">
                    {% for sm in matiere.sous_matieres %}
                    <div class="sous-matiere" onclick="toggleSousMatiere(this)">
                        {{ sm.nom }}
                        <span class="pastille-niveau {{ sm.niveau }}">{{ sm.niveau }}</span>
                    </div>

                    <div class="detail-sous-matiere">
                        <div class="evaluation">
                            <div class="ligne-eval">
                                <div class="titre-eval">{{ sm.nom }}</div>
                                <div class="note-global">
                                    {{ sm.note_finale }} / 20
                                    <span class="pastille-niveau {{ sm.niveau_final }}">{{ sm.niveau_final }}</span>
                                </div>
                            </div>

                            <div class="objectifs-liste">
                                {% for obj in sm.objectifs %}
                                <div class="objectif-ligne">
                                    <div class="objectif-texte">{{ obj.texte }}</div>
                                    <div class="note-objectif">
                                        <span class="pastille-niveau {{ obj.niveau }}">{{ obj.niveau }}</span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="bloc-moyennes-aligne">
        <div class="moyenne-eleve">
            <div class="titre">Moyenne générale</div>
            <div class="note">15.2 / 20</div>
            <div class="pastille-niveau pastille-grande A">A</div>
        </div>
        <div class="moyenne-classe">
            <div class="titre">Moyenne de la classe</div>
            <div class="note">13.8 / 20</div>
        </div>
    </div>
</div>

<script>
    function toggleMatiere(element) {
        const bloc = element.closest('.bloc-matiere');
        const blocs = document.querySelectorAll('.bloc-matiere');
        const alreadyActive = bloc.classList.contains('active');

        blocs.forEach((b) => b.classList.remove('active', 'moved'));

        if (!alreadyActive) {
            bloc.classList.add('active');
            let found = false;
            blocs.forEach((b) => {
                if (found && b !== bloc) b.classList.add('moved');
                if (b === bloc) found = true;
            });
        }
    }

    function toggleSousMatiere(element) {
        const detail = element.nextElementSibling;
        const all = document.querySelectorAll('.detail-sous-matiere');
        all.forEach(d => {
            if (d !== detail) d.classList.remove('visible');
        });
        if (detail) {
            detail.classList.toggle('visible');
        }
    }
</script>