{% extends "base.html" %}

{% block title %}Configuration des exports{% endblock %}
{% block header_title %}Paramètres & configuration{% endblock %}

{% block content %}
<div class="settings-page">

    <style>
        .settings-page {
            max-width: 980px;
            margin: 0;
            padding-right: 8px
        }

        .panel-card {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, .06);
            padding: 16px 18px;
            margin: 14px 0
        }

        .section-title {
            margin: 0 0 10px;
            font-size: 1.05rem;
            font-weight: 700;
            color: #1f2937
        }

        .form-row,
        .field_r {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin: 10px 0
        }

        label {
            font-weight: 600;
            font-size: .95rem;
            color: #111827
        }

        input[type="text"],
        input[type="number"] {
            border: 1px solid #d1d5db;
            border-radius: 10px;
            padding: 10px 12px;
            font-size: .95rem;
            background: #fff
        }

        .btnbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-start;
            margin-top: 12px
        }

        /* Boutons (charte) */
        .btn-classe {
            width: auto !important;
            display: inline-flex !important;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            border: 0;
            border-radius: 12px;
            font-weight: 800;
            text-decoration: none;
            background: #B5C800;
            color: #fff;
            box-shadow: 0 6px 16px rgba(0, 0, 0, .12), inset 0 1px 0 rgba(255, 255, 255, .18);
            transition: background .15s ease, transform .04s ease
        }

        .btn-classe:hover {
            background: #6B973F
        }

        .btn-classe:active {
            transform: translateY(1px)
        }

        .btn--muted {
            background: #BBBBBB !important;
            color: #111 !important
        }

        .btn--muted:hover {
            background: #AFAFAF !important
        }

        pre#test_result {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 10px 12px;
            margin-top: 8px
        }

        .section-sep {
            height: 2px;
            border: 0;
            margin: 18px 0;
            background: linear-gradient(to right, rgba(37, 99, 235, 0), rgba(37, 99, 235, .45), rgba(37, 99, 235, 0));
            border-radius: 9999px
        }

        /* Aperçu animé (double buffer) */
        .anim-stage {
            position: relative;
            height: 190px;
            border: 1px dashed #d1d5db;
            border-radius: 12px;
            overflow: hidden;
            background: #f9fafb;
            perspective: 1000px;
            display: grid;
            place-items: center
        }

        .anim-layer {
            grid-area: 1/1
        }

        .anim-preview-box {
            width: 80%;
            max-width: 560px;
            text-align: center;
            padding: 14px 14px 18px;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            backface-visibility: hidden;
            transform-style: preserve-3d;
            will-change: transform, opacity, clip-path, filter
        }

        /* Flèches */
        .anim-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            border-radius: 9999px;
            border: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #B5C800;
            color: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .15);
            font-weight: 800
        }

        .anim-nav:hover {
            background: #6B973F
        }

        .anim-nav.left {
            left: 10px
        }

        .anim-nav.right {
            right: 10px
        }

        .player-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px
        }

        #anim_name {
            font-size: 1.05rem
        }

        #anim_index {
            font-size: .95rem;
            color: #6b7280;
            margin-left: .5rem
        }

        #anim_name.just-saved::after {
            content: " • sauvegardé";
            font-weight: 600;
            color: #6B973F;
            margin-left: .35rem
        }
    </style>

    <div class="panel-card">
        <h3 class="section-title">Paramètres</h3>

        <form id="config_form" method="post" action="{{ url_for('main.config_export') }}">
            {# CSRF facultatif : rendu seulement si dispo #}
            {% if csrf_token is defined %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            {% endif %}

            <h4 class="section-title" style="margin-top:0">Chemins d’export</h4>

            <div class="field_r">
                <label for="primary_root">Chemin principal (UNC)</label>
                <input id="primary_root" name="primary_root" type="text" value="{{ primary_root or '' }}"
                    placeholder="ex. \\serveur\Documents\Education Nationale">
            </div>

            <div class="field_r">
                <label for="secondary_root">Chemin secondaire (lecteur mappé)</label>
                <input id="secondary_root" name="secondary_root" type="text" value="{{ secondary_root or '' }}"
                    placeholder="ex. Z:\Documents\Education Nationale">
            </div>

            <div class="field_r">
                <label for="reunions_dirname">Nom du dossier « Réunions »</label>
                <input id="reunions_dirname" name="reunions_dirname" type="text" value="{{ reunions_dirname or '' }}"
                    placeholder="ex. 19 - Réunions">
            </div>

            <div class="btnbar">
                <button type="button" id="btn_test" class="btn-classe">Tester l’accès</button>
            </div>
            <pre id="test_result" aria-live="polite"></pre>

            <hr class="section-sep" aria-hidden="true">

            {# Anim UI — valeur DB normalisée injectée #}
            {% set cur = current_anim_mode or 'slide-down' %}
            <input type="hidden" id="anim_mode" name="anim_mode" value="{{ current_anim_mode }}">
            <input type="number" id="anim_duration" name="anim_duration" value="{{ current_anim_duration }}" ...>


            <h4 class="section-title">Animation des panneaux</h4>
            <div class="form-row" style="gap:6px;align-items:flex-start;">
                <strong id="anim_name"></strong><span id="anim_index"></span>
            </div>

            <div class="anim-stage" id="anim_stage">
                <button type="button" id="anim_prev_btn" class="anim-nav left"
                    aria-label="Animation précédente">◀</button>
                <button type="button" id="anim_next_btn" class="anim-nav right"
                    aria-label="Animation suivante">▶</button>

                <div id="anim_layer_a" class="anim-preview-box anim-layer">
                    <div style="font-weight:700;margin-bottom:6px;">Exemple de panneau</div>
                    <div style="font-size:.95rem;color:#4b5563">L’aperçu rejoue en boucle l’animation sélectionnée.
                    </div>
                </div>
                <div id="anim_layer_b" class="anim-preview-box anim-layer" aria-hidden="true" style="opacity:0;">
                    <div style="font-weight:700;margin-bottom:6px;">Exemple de panneau</div>
                    <div style="font-size:.95rem;color:#4b5563">L’aperçu rejoue en boucle l’animation sélectionnée.
                    </div>
                </div>
            </div>

            <div class="player-bar">
                <button type="button" id="anim_toggle_btn" class="btn-classe">
                    <span class="icon">⏸</span> <span class="txt">Pause</span>
                </button>
            </div>

            <div class="form-row" style="margin-top:12px;">
                <label for="anim_duration">Durée (ms)</label>
                {% set dur = current_anim_duration or 520 %}
                <input type="number" id="anim_duration" name="anim_duration" min="200" max="5000" step="20"
                    value="{{ dur }}">
            </div>

            <div class="btnbar">
                <button type="submit" class="btn-classe">Enregistrer</button>
                <a class="btn-classe btn--muted" href="{{ url_for('main.index') }}">← Retour</a>
            </div>
        </form>
    </div>
</div>

<script>
    /* ===== Test d’accès (ne soumet pas le form) ===== */
    document.getElementById('btn_test')?.addEventListener('click', async () => {
        const p = document.getElementById('primary_root').value.trim();
        const s = document.getElementById('secondary_root').value.trim();
        const out = document.getElementById('test_result');
        out.textContent = "Test en cours…";
        try {
            const r = await fetch(`/api/config/test-paths?primary=${encodeURIComponent(p)}&secondary=${encodeURIComponent(s)}`);
            const data = await r.json();
            out.textContent =
                `Principal : ${data.primary.path}
  → ${data.primary.exists ? "✅ accessible" : "❌ indisponible"}

Secondaire : ${data.secondary.path}
  → ${data.secondary.exists ? "✅ accessible" : "❌ indisponible"}`;
        } catch (e) {
            out.textContent = "Erreur de test : " + (e.message || e);
        }
    });
</script>

<script>
    /* ===== Aperçu + Autosave (double-buffer + lock + boucle) ===== */
    (() => {
        const form = document.getElementById('config_form');
        const hidden = document.getElementById('anim_mode');
        const inputD = document.getElementById('anim_duration');
        const nameEl = document.getElementById('anim_name');
        const idxEl = document.getElementById('anim_index');
        const prevB = document.getElementById('anim_prev_btn');
        const nextB = document.getElementById('anim_next_btn');
        const togB = document.getElementById('anim_toggle_btn');
        const togI = togB?.querySelector('.icon');
        const togT = togB?.querySelector('.txt');
        const A = document.getElementById('anim_layer_a');
        const B = document.getElementById('anim_layer_b');
        if (!form || !hidden || !inputD || !nameEl || !A || !B) return;

        const CAN = !!(Element.prototype && Element.prototype.animate);
        const CSRF = form.querySelector('input[name="csrf_token"]')?.value || '';
        const GAP_MS = 3000; // délai entre 2 boucles

        const CHOICES = [
            'fade',
            'slide-up', 'slide-down', 'slide-left', 'slide-right',
            'wipe-up', 'wipe-down', 'wipe-left', 'wipe-right',
            'curtain-h', 'curtain-v',
            'clip-circle', 'clip-ellipse',
            'zoom-in', 'zoom-out', 'scale-pop',
            'flip-x', 'flip-y', 'hinge-top',
            'skew-in', 'rotate-in', 'newspaper',
            'blur-in', 'blur-zoom'
        ];
        const ALIAS = { slide: 'slide-down', wipe: 'wipe-down', clip: 'clip-circle', scale: 'zoom-in' };
        const LABEL = {
            'fade': 'Fondu',
            'slide-up': 'Slide vers le haut', 'slide-down': 'Slide vers le bas', 'slide-left': 'Slide vers la gauche', 'slide-right': 'Slide vers la droite',
            'wipe-up': 'Rideau bas → haut', 'wipe-down': 'Rideau haut → bas', 'wipe-left': 'Rideau droite → gauche', 'wipe-right': 'Rideau gauche → droite',
            'curtain-h': 'Rideau horizontal (centre)', 'curtain-v': 'Rideau vertical (centre)',
            'clip-circle': 'Découpe circulaire', 'clip-ellipse': 'Découpe elliptique',
            'zoom-in': 'Zoom entrant', 'zoom-out': 'Zoom sortant', 'scale-pop': 'Pop',
            'flip-x': 'Flip X', 'flip-y': 'Flip Y', 'hinge-top': 'Charnière (haut)',
            'skew-in': 'Skew', 'rotate-in': 'Rotation douce', 'newspaper': 'Journal',
            'blur-in': 'Flou → net', 'blur-zoom': 'Flou + zoom'
        };

        const resolveMode = m => CHOICES.includes(ALIAS[m] || m) ? (ALIAS[m] || m) : 'fade';
        const labelFor = m => LABEL[m] || m;
        const clamp = (n, min, max) => Math.max(min, Math.min(n, max));
        const getDur = () => {
            const base = Number(inputD.value || 520);
            const IN = clamp(Math.round(base), 50, 5000);
            const OUT = clamp(Math.round(IN * 0.25), 80, Math.max(80, IN - 40));
            return { IN, OUT };
        };

        const frames = (kind, dir) => {
            const show = (a, b) => dir === 'in' ? [a, b] : [b, a];
            switch (kind) {
                case 'fade': return show({ opacity: 0 }, { opacity: 1 });
                case 'slide-up': return show({ opacity: 0, transform: 'translateY(12px)' }, { opacity: 1, transform: 'translateY(0)' });
                case 'slide-down': return show({ opacity: 0, transform: 'translateY(-12px)' }, { opacity: 1, transform: 'translateY(0)' });
                case 'slide-left': return show({ opacity: 0, transform: 'translateX(16px)' }, { opacity: 1, transform: 'translateX(0)' });
                case 'slide-right': return show({ opacity: 0, transform: 'translateX(-16px)' }, { opacity: 1, transform: 'translateX(0)' });
                case 'wipe-down': return show({ clipPath: 'inset(0 0 100% 0)', opacity: 1 }, { clipPath: 'inset(0 0 0 0)', opacity: 1 });
                case 'wipe-up': return show({ clipPath: 'inset(100% 0 0 0)', opacity: 1 }, { clipPath: 'inset(0 0 0 0)', opacity: 1 });
                case 'wipe-right': return show({ clipPath: 'inset(0 100% 0 0)', opacity: 1 }, { clipPath: 'inset(0 0 0 0)', opacity: 1 });
                case 'wipe-left': return show({ clipPath: 'inset(0 0 0 100%)', opacity: 1 }, { clipPath: 'inset(0 0 0 0)', opacity: 1 });
                case 'curtain-h': return show({ clipPath: 'inset(0 50% 0 50%)', opacity: 1 }, { clipPath: 'inset(0 0 0 0)', opacity: 1 });
                case 'curtain-v': return show({ clipPath: 'inset(50% 0 50% 0)', opacity: 1 }, { clipPath: 'inset(0 0 0 0)', opacity: 1 });
                case 'clip-circle': return show({ opacity: 0, clipPath: 'circle(0% at 50% 40%)' }, { opacity: 1, clipPath: 'circle(140% at 50% 40%)' });
                case 'clip-ellipse': return show({ opacity: 0, clipPath: 'ellipse(20% 8% at 50% 35%)' }, { opacity: 1, clipPath: 'ellipse(120% 75% at 50% 35%)' });
                case 'zoom-in': return show({ opacity: 0, transform: 'scale(.92)' }, { opacity: 1, transform: 'scale(1)' });
                case 'zoom-out': return show({ opacity: 0, transform: 'scale(1.08)' }, { opacity: 1, transform: 'scale(1)' });
                case 'scale-pop': return show({ opacity: 0, transform: 'scale(.85)' }, { opacity: 1, transform: 'scale(1)' });
                case 'flip-x': return show({ opacity: 0, transform: 'rotateX(-90deg)' }, { opacity: 1, transform: 'rotateX(0)' });
                case 'flip-y': return show({ opacity: 0, transform: 'rotateY(90deg)' }, { opacity: 1, transform: 'rotateY(0)' });
                case 'hinge-top': return show({ opacity: 0, transformOrigin: 'top', transform: 'rotateX(-35deg)' }, { opacity: 1, transformOrigin: 'top', transform: 'rotateX(0)' });
                case 'skew-in': return show({ opacity: 0, transform: 'skewY(6deg) translateY(-8px)' }, { opacity: 1, transform: 'skewY(0) translateY(0)' });
                case 'rotate-in': return show({ opacity: 0, transform: 'rotate(-8deg) scale(.98)' }, { opacity: 1, transform: 'rotate(0) scale(1)' });
                case 'newspaper': return show({ opacity: 0, transform: 'rotate(-540deg) scale(.2)' }, { opacity: 1, transform: 'rotate(0) scale(1)' });
                case 'blur-in': return show({ opacity: 0, filter: 'blur(10px)' }, { opacity: 1, filter: 'blur(0)' });
                case 'blur-zoom': return show({ opacity: 0, transform: 'scale(.96)', filter: 'blur(12px)' }, { opacity: 1, transform: 'scale(1)', filter: 'blur(0)' });
                default: return show({ opacity: 0 }, { opacity: 1 });
            }
        };

        let active = A, idle = B, playing = true, locked = false, loopTimer = null;

        const cancelAll = el => { try { el.getAnimations?.forEach(a => a.cancel()); } catch { } };
        const clearInline = el => { el.style.opacity = ''; el.style.transform = ''; el.style.filter = ''; el.style.clipPath = ''; el.style.transformOrigin = ''; };
        const applyFrame = (el, f) => { for (const k in f) el.style[k] = f[k]; };
        const setLabel = mode => { const i = CHOICES.indexOf(mode); nameEl.textContent = labelFor(mode); idxEl.textContent = `(${i + 1}/${CHOICES.length})`; };

        // AUTOSAVE (urlencoded + JSON si dispo)
        async function autosave(immediate = false) {
            const run = async () => {
                const params = new URLSearchParams();
                params.set('anim_mode', hidden.value);
                params.set('anim_duration', inputD.value);
                if (CSRF) params.set('csrf_token', CSRF);
                try {
                    const res = await fetch(form.action, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Accept': 'application/json', 'X-Requested-With': 'fetch' },
                        body: params.toString(),
                        credentials: 'same-origin'
                    });
                    const ct = res.headers.get('Content-Type') || '';
                    if (ct.includes('application/json')) {
                        const data = await res.json();
                        if (data?.ui?.anim_mode) hidden.value = resolveMode(data.ui.anim_mode);
                        if (data?.ui?.anim_duration) inputD.value = data.ui.anim_duration;
                    }
                    nameEl.classList.add('just-saved');
                    setTimeout(() => nameEl.classList.remove('just-saved'), 900);
                } catch (e) { console.warn('autosave error', e); }
            };
            clearTimeout(autosave._t);
            if (immediate) run(); else autosave._t = setTimeout(run, 200);
        }

        const scheduleNext = () => {
            if (!playing) return;
            clearTimeout(loopTimer);
            loopTimer = setTimeout(() => { if (playing && !locked) loopOnce(); }, GAP_MS);
        };

        function loopOnce() {
            if (locked) return;
            const mode = resolveMode(hidden.value);
            const { IN, OUT } = getDur();
            setLabel(mode);
            cancelAll(active); cancelAll(idle);
            clearInline(idle);
            applyFrame(idle, frames(mode, 'in')[0]);
            idle.style.opacity = '1';

            if (!CAN) { [active, idle] = [idle, active]; scheduleNext(); return; }

            locked = true;
            const outAnim = active.animate(frames(mode, 'out'), { duration: Math.max(80, OUT), easing: 'cubic-bezier(.4,0,.2,1)', fill: 'forwards' });
            outAnim.finished.catch(() => { }).then(() => {
                const inAnim = idle.animate(frames(mode, 'in'), { duration: IN, easing: 'cubic-bezier(.22,.61,.36,1)', fill: 'both' });
                return inAnim.finished.catch(() => { });
            }).finally(() => {
                [active, idle] = [idle, active];
                locked = false;
                scheduleNext();
            });
        }

        // Changement par flèches : OUT de l’anim courante, set+save, IN de la nouvelle, puis boucle
        function changeToIndex(nextIdx) {
            if (locked) return;
            const cur = resolveMode(hidden.value);
            const curIdx = CHOICES.indexOf(cur);
            if (nextIdx === curIdx) return;

            const { OUT } = getDur();
            locked = true;
            // 1) sort avec l'anim courante
            if (CAN) {
                const outAnim = active.animate(frames(cur, 'out'), { duration: Math.max(80, OUT), easing: 'cubic-bezier(.4,0,.2,1)', fill: 'forwards' });
                outAnim.finished.catch(() => { }).finally(() => {
                    // 2) set + save la nouvelle, puis IN + reprise boucle
                    hidden.value = CHOICES[nextIdx];
                    autosave(true);
                    playing = true;
                    playFromScratch(); // fait l'entrée + relance la boucle
                });
            } else {
                hidden.value = CHOICES[nextIdx];
                autosave(true);
                playing = true;
                playFromScratch();
            }
        }

        function playFromScratch() {
            const mode = resolveMode(hidden.value);
            const { IN } = getDur();
            setLabel(mode);
            cancelAll(active); cancelAll(idle);
            clearInline(active); clearInline(idle);
            active.style.opacity = '0';
            applyFrame(idle, frames(mode, 'in')[0]);
            idle.style.opacity = '1';

            if (!CAN) { [active, idle] = [idle, active]; locked = false; scheduleNext(); return; }

            const inAnim = idle.animate(frames(mode, 'in'), { duration: IN, easing: 'cubic-bezier(.22,.61,.36,1)', fill: 'both' });
            inAnim.finished.catch(() => { }).finally(() => {
                [active, idle] = [idle, active];
                locked = false;
                scheduleNext();
            });
        }

        // Contrôles
        prevB?.addEventListener('click', () => {
            const cur = resolveMode(hidden.value);
            const i = (CHOICES.indexOf(cur) - 1 + CHOICES.length) % CHOICES.length;
            changeToIndex(i);
        });
        nextB?.addEventListener('click', () => {
            const cur = resolveMode(hidden.value);
            const i = (CHOICES.indexOf(cur) + 1) % CHOICES.length;
            changeToIndex(i);
        });
        window.addEventListener('keydown', e => {
            if (e.key === 'ArrowLeft') { e.preventDefault(); prevB.click(); }
            if (e.key === 'ArrowRight') { e.preventDefault(); nextB.click(); }
        });

        togB?.addEventListener('click', () => {
            if (playing) {
                playing = false; clearTimeout(loopTimer); loopTimer = null; cancelAll(active); cancelAll(idle);
                togI.textContent = '▶'; togT.textContent = 'Reprendre';
            } else {
                playing = true; togI.textContent = '⏸'; togT.textContent = 'Pause';
                playFromScratch();
            }
        });

        inputD.addEventListener('change', () => { autosave(); playing = true; playFromScratch(); });

        // Init — respecter la valeur DB telle quelle (normalisée côté serveur)
        hidden.value = resolveMode(hidden.value);
        setLabel(hidden.value);
        playing = true;
        playFromScratch();
    })();
</script>
{% endblock %}